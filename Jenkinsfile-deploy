pipeline {
    agent { label 'debian-agent' }

    environment {
        WEB_HOST = '192.168.56.106'
        DB_HOST  = '192.168.56.105'
        DB_USER  = 'wp_user'
        DB_PASS  = 'wp_pass'
        DB_NAME  = 'wordpress_db'
        SSH_USER = 'manuelcollado'
        ROOT_PASS = 'PapayMama2016'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Clonando repositorio...'
                checkout scm
            }
        }

        stage('Configurar Base de Datos') {
            steps {
                echo "üß© Configurando base de datos en ${DB_HOST}..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_USER}@${DB_HOST} '
                        sshpass -p "${ROOT_PASS}" su -c "
                            mysql -e \\"CREATE DATABASE IF NOT EXISTS ${DB_NAME};\\"
                            mysql -e \\"CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASS}';\\"
                            mysql -e \\"GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'%';\\"
                            mysql -e \\"FLUSH PRIVILEGES;\\"
                        "
                    '
                """
            }
        }

        stage('Desplegar WordPress') {
            steps {
                echo "üåê Instalando y configurando WordPress en ${WEB_HOST}..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_USER}@${WEB_HOST} '
                        sshpass -p "${ROOT_PASS}" su -c "
                            apt update
                            apt install -y apache2 php php-mysql wget unzip
                            cd /var/www/html
                            rm -rf wordpress
                            wget https://wordpress.org/latest.zip
                            unzip latest.zip
                            rm latest.zip
                            chown -R www-data:www-data wordpress
                            cd wordpress
                            cp wp-config-sample.php wp-config.php
                            sed -i \\"s/database_name_here/${DB_NAME}/\\" wp-config.php
                            sed -i \\"s/username_here/${DB_USER}/\\" wp-config.php
                            sed -i \\"s/password_here/${DB_PASS}/\\" wp-config.php
                            sed -i \\"s/localhost/${DB_HOST}/\\" wp-config.php
                            systemctl restart apache2
                        "
                    '
                """
            }
        }

        stage('Verificar Despliegue') {
            steps {
                echo "üß™ Verificando que WordPress responde correctamente..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_USER}@${WEB_HOST} '
                        curl -I http://localhost/wordpress | grep "200 OK" && echo "‚úÖ WordPress responde correctamente."
                    '
                """
            }
        }
    }

    post {
        success {
            echo "üéâ Despliegue de WordPress completado y conectado a MariaDB correctamente."
        }
        failure {
            echo "‚ùå Fall√≥ el despliegue. Revisa los logs del pipeline en Jenkins."
        }
    }
}

