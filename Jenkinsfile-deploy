pipeline {
    agent { label 'debian-agent' }

    environment {
        WEB_HOST = '192.168.56.106'
        DB_HOST  = '192.168.56.105'
        DB_USER  = 'wp_user'
        DB_PASS  = 'wp_pass'
        DB_NAME  = 'wordpress_db'
        SSH_USER = 'manuelcollado'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Clonando repositorio...'
                checkout scm
            }
        }

        stage('Configurar Base de Datos') {
            steps {
                echo "Configurando base de datos en ${DB_HOST}..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_USER}@${DB_HOST} '
                        sudo -n mysql -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME};"
                        sudo -n mysql -e "CREATE USER IF NOT EXISTS '\''${DB_USER}'\''@'\''%'\'' IDENTIFIED BY '\''${DB_PASS}'\'';"
                        sudo -n mysql -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '\''${DB_USER}'\''@'\''%'\'';"
                        sudo -n mysql -e "FLUSH PRIVILEGES;"
                    '
                """
            }
        }

        stage('Desplegar WordPress') {
            steps {
                echo "Instalando y configurando WordPress en ${WEB_HOST}..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_USER}@${WEB_HOST} '
                        sudo -n apt update
                        sudo -n apt install -y apache2 php php-mysql wget unzip
                        cd /var/www/html
                        sudo -n rm -rf wordpress
                        sudo -n wget https://wordpress.org/latest.zip
                        sudo -n unzip latest.zip
                        sudo -n rm latest.zip
                        sudo -n chown -R www-data:www-data wordpress
                        cd wordpress
                        sudo -n cp wp-config-sample.php wp-config.php
                        sudo -n sed -i "s/database_name_here/${DB_NAME}/" wp-config.php
                        sudo -n sed -i "s/username_here/${DB_USER}/" wp-config.php
                        sudo -n sed -i "s/password_here/${DB_PASS}/" wp-config.php
                        sudo -n sed -i "s/localhost/${DB_HOST}/" wp-config.php
                        sudo -n systemctl restart apache2
                    '
                """
            }
        }

        stage('Verificar Despliegue') {
            steps {
                echo "Verificando que WordPress responde correctamente..."
                sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_USER}@${WEB_HOST} '
                        curl -I http://localhost/wordpress | grep "200 OK" && echo "WordPress responde correctamente."
                    '
                """
            }
        }
    }

    post {
        success {
            echo "Despliegue de WordPress completado y conectado a MariaDB correctamente."
        }
        failure {
            echo "Fall√≥ el despliegue. Revisa los logs del pipeline en Jenkins."
        }
    }
}

